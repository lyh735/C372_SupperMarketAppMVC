<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket App</title>
</head>
<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Supermarket App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/cart">View Cart</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/feedback">Leave Feedback</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout">Logout</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

  <div class="container">
    <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
    <br>
    <div class="text-center"><h2>Products from Supermarket</h2></div>
    <br>

    <!-- Search and Filter Panel -->
    <div class="card mb-4 p-4 bg-light">
      <h5 class="mb-3">Search & Filter</h5>
      <form method="GET" action="/shopping" class="row g-3">
        
        <!-- Search by Product Name -->
        <div class="col-md-3">
          <label for="search" class="form-label">Search Product</label>
          <input type="text" class="form-control" id="search" name="search" placeholder="Product name..." value="<%= searchQuery %>">
        </div>

        <!-- Filter by Category -->
        <div class="col-md-3">
          <label for="category" class="form-label">Category</label>
          <select class="form-select" id="category" name="category">
            <option value="">All Categories</option>
            <% categories.forEach(cat => { %>
              <option value="<%= cat %>" <% if (categoryFilter === cat) { %>selected<% } %>>
                <%= cat %>
              </option>
            <% }); %>
          </select>
        </div>

        <!-- Sort by Price -->
        <div class="col-md-3">
          <label for="priceSort" class="form-label">Price</label>
          <select class="form-select" id="priceSort" name="priceSort">
            <option value="">Default</option>
            <option value="asc" <% if (priceSort === 'asc') { %>selected<% } %>>Lowest to Highest</option>
            <option value="desc" <% if (priceSort === 'desc') { %>selected<% } %>>Highest to Lowest</option>
          </select>
        </div>

        <!-- Sort by Rating -->
        <div class="col-md-3">
          <label for="ratingSort" class="form-label">Rating</label>
          <select class="form-select" id="ratingSort" name="ratingSort">
            <option value="">Default</option>
            <option value="highest" <% if (ratingSort === 'highest') { %>selected<% } %>>Highest Rating First</option>
            <option value="lowest" <% if (ratingSort === 'lowest') { %>selected<% } %>>Lowest Rating First</option>
            <option value="no-rating" <% if (ratingSort === 'no-rating') { %>selected<% } %>>No Rating First</option>
          </select>
        </div>

        <!-- Search Button -->
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
          <a href="/shopping" class="btn btn-secondary">Clear Filters</a>
        </div>
      </form>
    </div>

    <% 
      // Group products by category
      const groupedByCategory = {};
      products.forEach(product => {
        const category = product.category || 'Uncategorized';
        if (!groupedByCategory[category]) {
          groupedByCategory[category] = [];
        }
        groupedByCategory[category].push(product);
      });

      // Get sorted category names
      const displayCategories = Object.keys(groupedByCategory).sort();
    %>

    <% if (products.length === 0) { %>
      <div class="alert alert-info text-center">No products found matching your search or filters.</div>
    <% } else { %>
      <% displayCategories.forEach(category => { %>
        <div class="mb-5">
          <h3 class="mb-3"><span class="badge bg-primary"><%= category %></span></h3>
          <table class="table table-hover small text-center">
            <thead class="table-light">
              <tr>
                <th width="100">Product Name</th>
                <th width="100">Product Image</th>
                <th width="50">Quantity</th>
                <th width="50">Price</th>
                <th width="80">Avg Rating</th>
                <th width="50">Buy</th>
              </tr>
            </thead>
            <tbody>
              <% groupedByCategory[category].forEach(product => { %>
                <tr>
                  <td><a href="/product/<%= product.id %>" ><%= product.productName %></a></td>
                  <td><img src = "images/<%= product.image %>" width="20%"></td>
                  <td><%= product.quantity %></td>
                  <td>$<%= product.price.toFixed(2) %></td>
                  <td>
                    <% if (product.avgRating !== null && product.avgRating !== undefined) { 
                        let badgeColor = 'bg-danger';

                        if (product.avgRating > 3.0) {
                          badgeColor = 'bg-success';
                        } else if (product.avgRating > 1.0) {
                          badgeColor = 'bg-warning';
                        }
                    %>
                      <span class="badge <%= badgeColor %>">
                        <%= product.avgRating.toFixed(1) %>/5
                      </span>
                      <small class="d-block text-muted">
                        (<%= product.ratingCount %> reviews)
                      </small>
                    <% } else { %>
                      <span class="badge bg-secondary">No Rating</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (product.quantity > 0) { %>
                      <select class="form-control" onchange="document.getElementById('quantity-<%= product.id %>').value = this.value">
                        <% for (let q = 1; q <= Math.min(product.quantity, 5); q++) { %>
                          <option value="<%= q %>"><%= q %></option>
                        <% } %>
                      </select>
                    <% } else { %>
                      <span class="text-danger">Out of Stock</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (product.quantity > 0) { %>
                      <form action="/add-to-cart/<%= product.id %>" method="POST">
                        <input type="hidden" name="quantity" id="quantity-<%= product.id %>" value="1">
                        <button type="submit" class="btn btn-primary btn-sm mt-2">Buy</button>
                      </form>
                    <% } else { %>
                      <button type="button" class="btn btn-secondary btn-sm mt-2" disabled>Out of Stock</button>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% }); %>
    <% } %>

  </div>
</body>
</html>
